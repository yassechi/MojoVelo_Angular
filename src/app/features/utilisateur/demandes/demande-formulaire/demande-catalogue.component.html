<div class="user-demande-form-page page-shell">
  <p-toast></p-toast>
  <div class="page-header">
    <div>
      <h1 class="page-title">{{ isEdit ? 'Modifier ma demande' : 'Creer une demande' }}</h1>
      <p class="page-subtitle">Gestion de votre demande</p>
    </div>
    <p-button
      label="Retour"
      icon="pi pi-arrow-left"
      class="p-button-text"
      (click)="goBack()"
    ></p-button>
  </div>

  <p-card>
    <form [formGroup]="form">
      <div class="grid">
        <div class="col-12">
          <div class="field mb-4">
            <label class="block mb-2 font-semibold">Recherche de velo</label>
            <span class="p-input-icon-left w-full">
              <i class="pi pi-search"></i>
              <input
                pInputText
                type="text"
                class="w-full"
                placeholder="Rechercher par modele, type ou marque"
                [(ngModel)]="searchTerm"
                [ngModelOptions]="{ standalone: true }"
                (ngModelChange)="onFilterChange()"
              />
            </span>
          </div>
        </div>
        <div class="col-12 md:col-4">
          <div class="field mb-4">
            <label class="block mb-2 font-semibold">Marque</label>
            <p-select
              [options]="brandOptions"
              [(ngModel)]="selectedBrandId"
              [ngModelOptions]="{ standalone: true }"
              placeholder="Toutes"
              optionLabel="label"
              optionValue="value"
              class="w-full"
              [showClear]="true"
              (ngModelChange)="onFilterChange()"
            ></p-select>
          </div>
        </div>
        <div class="col-12 md:col-4">
          <div class="field mb-4">
            <label class="block mb-2 font-semibold">Type</label>
            <p-select
              [options]="typeOptions"
              [(ngModel)]="selectedType"
              [ngModelOptions]="{ standalone: true }"
              placeholder="Tous"
              optionLabel="label"
              optionValue="value"
              class="w-full"
              [showClear]="true"
              (ngModelChange)="onFilterChange()"
            ></p-select>
          </div>
        </div>
        <div class="col-12 md:col-2">
          <div class="field mb-4">
            <label class="block mb-2 font-semibold">Prix min</label>
            <p-inputnumber
              [(ngModel)]="minPrice"
              [ngModelOptions]="{ standalone: true }"
              mode="decimal"
              [minFractionDigits]="0"
              class="w-full"
              [style]="{ width: '100%' }"
              (ngModelChange)="onFilterChange()"
            ></p-inputnumber>
          </div>
        </div>
        <div class="col-12 md:col-2">
          <div class="field mb-4">
            <label class="block mb-2 font-semibold">Prix max</label>
            <p-inputnumber
              [(ngModel)]="maxPrice"
              [ngModelOptions]="{ standalone: true }"
              mode="decimal"
              [minFractionDigits]="0"
              class="w-full"
              [style]="{ width: '100%' }"
              (ngModelChange)="onFilterChange()"
            ></p-inputnumber>
          </div>
        </div>

        <div class="col-12">
          @if (loadingBikes) {
            <div class="text-center py-5">
              <i class="pi pi-spin pi-spinner" style="font-size: 2.5rem; color: #1e3a8a;"></i>
              <p class="mt-3 text-600">Chargement des velos...</p>
            </div>
          } @else {
            <div class="bike-grid">
              @for (bike of pagedBikes; track bike.id) {
                <div class="bike-card" [class.selected]="bike.id === selectedBikeId">
                  <button type="button" class="bike-image" (click)="selectBike(bike)">
                    @if (getBikeImage(bike); as imgUrl) {
                      <img [src]="imgUrl" [alt]="bike.title.rendered" />
                    } @else {
                      <div class="bike-image-placeholder">
                        <i class="pi pi-image"></i>
                      </div>
                    }
                    @if (bike.id === selectedBikeId) {
                      <span class="bike-selected">Selectionne</span>
                    }
                  </button>
                  <div class="bike-card-header">
                    <h3 class="bike-title">{{ bike.title.rendered }}</h3>
                    <span class="bike-brand">{{ getBrandName(bike.bikes_brand?.[0]) }}</span>
                  </div>
                  <div class="bike-meta">
                    <span>{{ bike.acf?.type || 'Type non renseigne' }}</span>
                    <span>{{ formatCurrency(bike.acf?.prix) }}</span>
                  </div>
                  <div class="bike-meta">
                    <span>Mensuel</span>
                    <span>{{ formatCurrency(bike.acf?.prix_par_mois) }}</span>
                  </div>
                  <p-button
                    [label]="bike.id === selectedBikeId ? 'Selectionne' : 'Choisir'"
                    [severity]="bike.id === selectedBikeId ? 'success' : 'secondary'"
                    (onClick)="selectBike(bike)"
                    size="small"
                  ></p-button>
                </div>
              } @empty {
                <div class="text-center py-5 text-600">Aucun velo trouve</div>
              }
            </div>
          }
          @if (form.get('idVelo')?.invalid && form.get('idVelo')?.touched) {
            <small class="p-error">Le velo est obligatoire</small>
          }
        </div>

        @if (!loadingBikes && filteredBikes.length > pageSize) {
          <div class="col-12">
            <div class="pagination">
              <button type="button" class="page-btn" (click)="prevPage()" [disabled]="currentPage === 1">
                Pr&eacute;c&eacute;dent
              </button>
              <div class="page-info">
                Page {{ currentPage }} / {{ totalPages }}
              </div>
              <button type="button" class="page-btn" (click)="nextPage()" [disabled]="currentPage === totalPages">
                Suivant
              </button>
            </div>
          </div>
        }
      </div>

      <div class="flex justify-content-end gap-2 mt-4">
        <p-button label="Annuler" (onClick)="goBack()" class="p-button-text"></p-button>
        <p-button
          [label]="isEdit ? 'Sauvegarder' : 'Creer'"
          icon="pi pi-check"
          (onClick)="onSubmit()"
          [loading]="loading"
          [disabled]="form.invalid || !selectedBikeId"
        ></p-button>
      </div>
    </form>
  </p-card>
</div>

