<p-card styleClass="section-card">
  <ng-template pTemplate="header">
    <div class="p-3 flex justify-content-between align-items-center">
      <h3 class="m-0">Amortissement</h3>
      @if (amortissements().length > 0 && !editingAmortissement) {
        <p-button icon="pi pi-pencil" label="Modifier" size="small" (onClick)="onEditAmortissement(amortissements()[0])"></p-button>
      }
    </div>
  </ng-template>

  @if (amortissements().length > 0) {
    @for (amort of amortissements(); track amort.id) {
      <div class="mb-3">
        @if (!editingAmortissement) {
          <div class="grid">
            <div class="col-6">
              <p class="text-600 mb-1">Date d&eacute;but</p>
              <p class="font-semibold">{{ formatDate(amort.dateDebut) }}</p>
            </div>
            <div class="col-6">
              <p class="text-600 mb-1">Dur&eacute;e</p>
              <p class="font-semibold">{{ amort.dureeMois }} mois</p>
            </div>
            <div class="col-6">
              <p class="text-600 mb-1">Valeur initiale</p>
              <p class="font-semibold">{{ formatCurrency(amort.valeurInit) }}</p>
            </div>
            <div class="col-6">
              <p class="text-600 mb-1">Valeur r&eacute;siduelle</p>
              <p class="font-semibold">{{ formatCurrency(amort.valeurResiduelleFinale) }}</p>
            </div>
            <div class="col-12">
              <p class="text-600 mb-1">Amortissement mensuel</p>
              <p class="font-semibold text-primary-500">
                {{ formatCurrency((amort.valeurInit - amort.valeurResiduelleFinale) / amort.dureeMois) }}
              </p>
            </div>
          </div>
        }

        @if (editingAmortissement && currentAmortissement?.id === amort.id) {
          <div class="mb-3">
            <p class="text-600 mb-2">Valeur initiale: <strong>{{ formatCurrency(amort.valeurInit) }}</strong></p>
            <p class="text-600 mb-2">Dur&eacute;e: <strong>{{ amort.dureeMois }} mois</strong></p>
          </div>

          <p-divider></p-divider>

          <div class="grid mt-3">
            @for (value of amortissementValues; track $index; let i = $index) {
              <div class="col-6 md:col-4 lg:col-3">
                <label class="block text-600 mb-1">Mois {{ i + 1 }}</label>
                <input
                  type="number"
                  pInputText
                  [(ngModel)]="amortissementValues[i]"
                  class="w-full"
                  [style.text-align]="'right'"
                />
              </div>
            }
          </div>

          <p-divider></p-divider>

          <div class="mt-3 flex justify-content-between align-items-center">
            <div>
              <p class="text-600 m-0">Total amortissement:</p>
              <p class="font-bold text-xl m-0">
                {{ formatCurrency(getTotalAmortissement()) }}
              </p>
            </div>
            <div class="flex gap-2">
              <p-button label="Annuler" severity="secondary" (onClick)="onCancelEditAmortissement()"></p-button>
              <p-button label="Enregistrer" icon="pi pi-check" (onClick)="onSaveAmortissement()"></p-button>
            </div>
          </div>
        }
      </div>
    }
  } @else {
    <p class="text-600">Calcul d'amortissement non disponible.</p>
  }
</p-card>
