<div class="demande-detail-page page-shell">
  <p-toast></p-toast>

  <div class="page-header">
    <div>
      <h1 class="page-title">Detail de la demande</h1>
      <p class="page-subtitle">Validation RH et suivi</p>
    </div>
    <div class="flex gap-2">
      <p-button label="Retour" icon="pi pi-arrow-left" styleClass="p-button-text" (click)="goBack()"></p-button>
      <p-button label="Modifier" icon="pi pi-pencil" (click)="goEdit()" [disabled]="!demandeId"></p-button>
    </div>
  </div>

  <p-card *ngIf="demande; else loadingTpl" styleClass="section-card">
    <div class="grid">
      <div class="col-12 lg:col-8">
        <div class="detail-section">
          <h3>Informations employe</h3>
          <div class="info-grid">
            <div>
              <div class="text-600 text-sm">Nom</div>
              <div class="font-semibold">{{ demande.userName }}</div>
            </div>
            <div>
              <div class="text-600 text-sm">Email</div>
              <div class="font-semibold">{{ demande.userEmail }}</div>
            </div>
            <div>
              <div class="text-600 text-sm">Identifiant</div>
              <div class="font-semibold">{{ demande.idUser }}</div>
            </div>
            <div>
              <div class="text-600 text-sm">Statut</div>
              <p-tag [value]="getStatusLabel(demande.status)" [severity]="getStatusSeverity(demande.status)" [styleClass]="getStatusClass(demande.status)"></p-tag>
            </div>
          </div>
        </div>

        <div class="detail-section">
          <h3>Velo selectionne</h3>
          <div class="info-grid">
            <div>
              <div class="text-600 text-sm">Modele</div>
              <div class="font-semibold">{{ bike?.title?.rendered || demande.veloModele || '-' }}</div>
            </div>
            <div>
              <div class="text-600 text-sm">Marque</div>
              <div class="font-semibold">{{ demande.veloMarque || 'Non renseignee' }}</div>
            </div>
            <div>
              <div class="text-600 text-sm">Type</div>
              <div class="font-semibold">{{ demande.veloType || '-' }}</div>
            </div>
            <div>
              <div class="text-600 text-sm">Prix TVAC</div>
              <div class="font-semibold">{{ formatCurrency(demande.veloPrixAchat) }}</div>
            </div>
          </div>
        </div>

        <div class="detail-section">
          <h3>Accessoires</h3>
          <div class="text-600">Cadenas certifie (obligatoire)</div>
          <div class="text-600">Souhaites : {{ demande.accessoiresSouhaites || 'Non renseignes' }}</div>
        </div>
      </div>

      <div class="col-12 lg:col-4">
        <div class="summary-card">
          <h3>Recapitulatif financier</h3>
          <div class="summary-line">
            <span>Velo</span>
            <span>{{ formatCurrency(demande.veloPrixAchat) }}</span>
          </div>
          <div class="summary-line">
            <span>Accessoires</span>
            <span>Sur devis</span>
          </div>
          <div class="summary-line total">
            <span>Total estime</span>
            <span>{{ formatCurrency(demande.veloPrixAchat) }}</span>
          </div>
          <div class="summary-hint">Duree 36 mois · Services inclus</div>
        </div>

        <div class="validation-card">
          <h3>{{ isUserView ? 'Validation Client' : 'Validation Admin' }}</h3>
          <div class="flex gap-2 mt-3">
            <p-button
              label="Valider"
              icon="pi pi-check"
              (click)="onValidate()"
              [disabled]="isValidateDisabled()"
            ></p-button>
            <p-button
              label="Refuser"
              icon="pi pi-times"
              styleClass="p-button-danger"
              (click)="onDecision(DemandeStatus.Refuse)"
              [disabled]="demande.status === DemandeStatus.Refuse"
            ></p-button>
          </div>
        </div>

        <div class="bike-preview-card">
          <div class="bike-preview-image">
            @if (getBikeImage(bike); as imgUrl) {
              <img [src]="imgUrl" [alt]="bike?.title?.rendered || 'Velo'" />
            } @else {
              <div class="bike-preview-placeholder">
                <i class="pi pi-image"></i>
              </div>
            }
          </div>
          <div class="bike-preview-title">
            {{ bike?.title?.rendered || demande.veloModele || 'Velo' }}
          </div>
        </div>
      </div>

      <div class="col-12">
        <div class="detail-section">
          <h3>Discussion</h3>
          <div class="message-card">
            @if (loadingMessages) {
              <div class="text-600">Chargement des messages...</div>
            } @else if (messages.length === 0) {
              <div class="text-600">Aucun message pour cette demande.</div>
            } @else {
              <div class="message-list">
                @for (message of messages; track message.id) {
                  <div class="message-item" [class.own]="isOwnMessage(message)">
                    <div class="message-bubble">
                      <div class="message-author">{{ message.roleLabel }}</div>
                      <div class="message-content">{{ message.contenu }}</div>
                      <div class="message-date">
                        {{ (message.dateEnvoi || message.createdDate) | date: 'dd/MM/yyyy HH:mm' }}
                      </div>
                    </div>
                  </div>
                }
              </div>
            }

            <div class="message-input">
              <textarea
                pInputTextarea
                rows="3"
                class="w-full"
                placeholder="Ecrire un message..."
                [(ngModel)]="messageText"
              ></textarea>
              <div class="flex justify-content-end mt-2">
                <p-button
                  label="Envoyer"
                  icon="pi pi-send"
                  (click)="sendMessage()"
                  [loading]="sendingMessage"
                  [disabled]="!messageText.trim()"
                ></p-button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </p-card>

  <ng-template #loadingTpl>
    <p-card>
      <div class="text-600">Chargement...</div>
    </p-card>
  </ng-template>
</div>






